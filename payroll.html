<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neerada Payroll System v2026 (Modular)</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Inter:wght@100..900&family=Playfair+Display:ital,wght@0,700;1,700&family=Noto+Sans+Lao:wght@100..900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <style>
        /* --- CORE VARIABLES --- */
        :root {
            --primary-900: #1e3a8a; --primary-800: #1e40af; --primary-700: #1d4ed8;
            --primary-600: #2563eb; --primary-100: #dbeafe; --primary-50: #eff6ff;
        }

        /* --- TYPOGRAPHY --- */
        body { font-family: 'Inter', 'Noto Sans Lao', sans-serif; }
        .font-hero { font-family: 'Playfair Display', serif; }
        .font-cursive { font-family: 'Dancing Script', cursive; }

        /* --- GLASSMORPHISM --- */
        .glass {
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
        }
        .glass-hero {
            background: rgba(255, 255, 255, 0.65); backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.6); border-radius: 2rem; padding: 3rem;
            display: inline-block; box-shadow: 0 20px 40px 0 rgba(0, 0, 0, 0.1);
        }

        /* --- VIEW STATES --- */
        body.view-landing {
            background-image: url('https://images.unsplash.com/photo-1554224155-6726b3ff858f?ixlib=rb-1.2.1&auto=format&fit=crop&w=1950&q=80');
            background-attachment: fixed; background-size: cover; background-position: center;
        }
        body.view-app { background-color: #f3f4f6; height: 100vh; overflow: hidden; }

        /* --- UTILITIES --- */
        .hover-3d { transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .hover-3d:hover { transform: translateY(-5px); }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 3px; }

        /* Print Styles */
        @media print {
            @page { size: auto; margin: 0mm; }
            body * { visibility: hidden; }
            #preview-pane, #preview-pane * { visibility: visible; }
            #preview-pane { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 15mm; background: white; border: none; box-shadow: none; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="view-landing theme-default">
<div id="landing-view" class="min-h-screen flex flex-col relative z-10 transition-opacity duration-500">
        <nav class="fixed w-full z-50 p-4">
            <div class="max-w-7xl mx-auto glass rounded-full px-6 py-3 flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <div id="landing-logo-container" class="bg-blue-900/10 p-2 rounded-full"><i data-lucide="hexagon" class="w-6 h-6 text-blue-900"></i></div>
                    <img id="landing-custom-logo" src="" class="w-10 h-10 object-cover rounded-full hidden" />
                    <span class="font-hero text-xl font-bold tracking-wide text-blue-900">Neerada</span>
                </div>
                <button onclick="App.UI.launch()" class="bg-blue-900 hover:bg-blue-800 text-white px-5 py-2 rounded-full text-sm font-semibold shadow-lg hover:scale-105 transition-transform">Launch System</button>
            </div>
        </nav>

        <section class="relative pt-32 pb-16 lg:pt-48 px-6 text-center">
            <div class="max-w-5xl mx-auto">
                <div class="glass-hero mb-10">
                    <h1 class="font-hero text-5xl md:text-7xl font-black mb-4 leading-tight">
                        <span class="text-slate-800">Neerada Payroll</span><br>
                        <span class="text-blue-700 italic">System</span>
                    </h1>
                    <p class="text-lg text-slate-600 font-medium">Precision. Elegance. Efficiency.</p>
                </div>
                <div class="flex justify-center gap-4">
                    <button onclick="App.UI.launch()" class="px-8 py-4 bg-blue-900 text-white rounded-xl font-bold text-lg shadow-2xl hover:bg-blue-800 hover-3d flex items-center gap-3">
                        <span>Enter Dashboard</span> <i data-lucide="arrow-right" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
        </section>

        <footer class="mt-auto glass text-slate-600 py-4 px-6 text-center text-xs">
            <p>© 2026 Neerada School Payroll System. All rights reserved.</p>
        </footer>
    </div>

    <div id="app-view" class="hidden flex flex-col h-full relative z-0">
        
        <header class="bg-blue-900 text-white p-3 shadow-md flex justify-between items-center z-20 shrink-0">
            <div class="flex items-center gap-4">
                <img id="header-custom-logo" src="" class="w-8 h-8 object-cover rounded-full hidden md:block" />
                <div>
                    <h1 class="font-bold text-lg leading-tight">Neerada Payroll</h1>
                    <p class="text-[10px] text-blue-300">Unified System v2026 (Modular)</p>
                </div>
                
                <div class="hidden md:flex bg-blue-800 rounded-lg p-1 ml-6 space-x-1">
                    <button data-tab="dashboard" onclick="App.UI.switchTab('dashboard')" class="tab-btn px-4 py-1.5 text-sm font-medium rounded-md bg-blue-900 text-white">Dashboard</button>
                    <button data-tab="payroll" onclick="App.UI.switchTab('payroll')" class="tab-btn px-4 py-1.5 text-sm font-medium rounded-md text-blue-100 hover:bg-blue-700">Staff Manager</button>
                    <button data-tab="reports" onclick="App.UI.switchTab('reports')" class="tab-btn px-4 py-1.5 text-sm font-medium rounded-md text-blue-100 hover:bg-blue-700">Reports & OT</button>
                </div>
            </div>
            
            <div class="flex items-center gap-2">
                <button onclick="window.location.reload()" class="p-2 hover:bg-blue-800 rounded-full" title="Home"><i data-lucide="home" class="w-4 h-4"></i></button>
                <button onclick="App.UI.Modals.open('settings')" class="p-2 hover:bg-blue-800 rounded-full" title="Settings"><i data-lucide="settings" class="w-4 h-4"></i></button>
                <div class="px-3 py-1 bg-blue-800 rounded text-xs font-mono" id="date-display">...</div>
            </div>
        </header>

        <div id="main-content" class="flex-1 overflow-hidden relative bg-gray-100">
            
            <div id="view-dashboard" class="view-section h-full overflow-y-auto p-6">
                <div class="max-w-6xl mx-auto space-y-6">
                    <div class="flex justify-between items-end">
                        <div><h2 class="text-2xl font-bold text-gray-800">Overview</h2><p class="text-gray-500 text-sm">Financial Summary</p></div>
                        <div class="flex gap-2 bg-white p-1 rounded border shadow-sm">
                            <select id="dash-year" onchange="App.UI.updateDashboard()" class="p-2 text-sm outline-none bg-transparent"></select>
                            <select id="dash-month" onchange="App.UI.updateDashboard()" class="p-2 text-sm outline-none bg-transparent border-l"></select>
                            <button onclick="App.Logic.exportBankReport()" class="bg-yellow-500 text-white px-3 py-1 rounded text-xs font-bold hover:bg-yellow-600">Bank Report</button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                            <p class="text-xs font-bold text-gray-400 uppercase">Total LAK</p>
                            <p id="stat-lak" class="text-2xl font-mono font-bold text-blue-900 mt-2">₭ 0</p>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                            <p class="text-xs font-bold text-gray-400 uppercase">Total USD</p>
                            <p id="stat-usd" class="text-2xl font-mono font-bold text-green-700 mt-2">$0.00</p>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                            <p class="text-xs font-bold text-gray-400 uppercase">Staff Count</p>
                            <p id="stat-count" class="text-3xl font-bold text-gray-800 mt-2">0</p>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <div class="p-4 bg-gray-50 border-b font-bold text-gray-700">Payroll Run History</div>
                        <div id="history-log-container" class="max-h-64 overflow-y-auto">
                            </div>
                    </div>
                </div>
            </div>

            <div id="view-payroll" class="view-section hidden h-full flex flex-col lg:flex-row">
                <aside class="w-full lg:w-72 bg-white border-r border-gray-200 flex flex-col z-10">
                    <div class="p-3 border-b bg-gray-50 flex justify-between items-center">
                        <span class="font-bold text-gray-700 text-sm">Staff List</span>
                        <div class="flex gap-1">
                            <button onclick="App.UI.Modals.open('staff')" class="p-1.5 bg-blue-100 text-blue-600 rounded hover:bg-blue-200"><i data-lucide="plus" class="w-4 h-4"></i></button>
                            <button onclick="App.Logic.Data.triggerImport()" class="p-1.5 bg-green-100 text-green-600 rounded hover:bg-green-200"><i data-lucide="upload" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                    <div class="p-2 border-b">
                        <select id="filter-dept" onchange="App.UI.renderStaffList()" class="w-full text-xs p-2 border rounded bg-gray-50">
                            <option value="All">All Departments</option>
                            </select>
                    </div>
                    <div id="staff-list" class="flex-1 overflow-y-auto p-2 space-y-1">
                        </div>
                </aside>

                <main class="flex-1 flex flex-col xl:flex-row bg-gray-100 p-4 gap-4 overflow-hidden relative">
                    <div id="empty-state" class="absolute inset-0 flex flex-col items-center justify-center text-gray-400 z-0">
                        <i data-lucide="mouse-pointer-2" class="w-12 h-12 mb-2"></i>
                        <p>Select an employee to start editing</p>
                    </div>

                    <div id="editor-column" class="hidden w-full xl:w-1/3 flex flex-col gap-4 z-10 h-full">
                        <div class="bg-white p-3 rounded-lg shadow-sm border flex justify-between items-center">
                            <span class="text-xs font-bold uppercase text-gray-500">Pay Period</span>
                            <div class="flex gap-2">
                                <select id="editor-month" onchange="App.UI.loadPeriod()" class="text-sm border rounded p-1"></select>
                                <select id="editor-year" onchange="App.UI.loadPeriod()" class="text-sm border rounded p-1"></select>
                            </div>
                        </div>

                        <div class="bg-white p-3 rounded-lg shadow-sm border grid grid-cols-2 gap-2">
                            <button onclick="App.UI.saveCurrent()" class="bg-green-600 text-white py-2 rounded text-xs font-bold hover:bg-green-700 flex items-center justify-center gap-2 col-span-2">
                                <i data-lucide="save" class="w-4 h-4"></i> Save Data
                            </button>
                            <button onclick="App.Logic.copyPrevious()" class="bg-orange-50 text-orange-700 border border-orange-200 py-2 rounded text-xs font-bold hover:bg-orange-100">Copy Prev</button>
                            <button onclick="App.UI.resetCurrent()" class="bg-red-50 text-red-700 border border-red-200 py-2 rounded text-xs font-bold hover:bg-red-100">Reset</button>
                        </div>

                        <div id="editor-inputs" class="flex-1 overflow-y-auto pr-1">
                            </div>
                    </div>

                    <div id="preview-column" class="hidden w-full xl:w-2/3 bg-white shadow-lg border rounded-lg p-8 overflow-y-auto z-10">
                        <div id="preview-pane" class="max-w-2xl mx-auto">
                            </div>
                    </div>
                </main>
            </div>
        </div>

        <div id="modal-staff" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 p-4">
            <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md">
                <h3 class="font-bold text-lg mb-4 text-blue-900">Staff Details</h3>
                <form id="form-staff" onsubmit="App.Logic.Data.saveStaff(event)" class="space-y-3">
                    <input type="hidden" name="id">
                    <div><label class="text-xs font-bold text-gray-500 uppercase">Name</label><input name="name" required class="w-full border p-2 rounded text-sm"></div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="text-xs font-bold text-gray-500 uppercase">Campus</label>
                            <select name="campus" class="w-full border p-2 rounded text-sm bg-gray-50">
                                <option>Sibounheuang</option><option>Chommany</option><option>General Services</option>
                            </select>
                        </div>
                        <div><label class="text-xs font-bold text-gray-500 uppercase">Dept</label>
                            <select name="department" id="modal-dept-select" class="w-full border p-2 rounded text-sm"></select>
                        </div>
                    </div>
                    <div><label class="text-xs font-bold text-gray-500 uppercase">Position</label><input name="position" class="w-full border p-2 rounded text-sm"></div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="text-xs font-bold text-gray-500 uppercase">LAK Bank</label><input name="bankLak" class="w-full border p-2 rounded text-sm"></div>
                        <div><label class="text-xs font-bold text-gray-500 uppercase">USD Bank</label><input name="bankUsd" class="w-full border p-2 rounded text-sm"></div>
                    </div>
                    <div class="flex gap-2 pt-4">
                        <button type="button" onclick="App.UI.Modals.close('staff')" class="flex-1 py-2 text-gray-600 hover:bg-gray-100 rounded">Cancel</button>
                        <button type="submit" class="flex-1 py-2 bg-blue-600 text-white rounded font-bold hover:bg-blue-700">Save</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="modal-settings" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 p-4">
            <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm">
                <h3 class="font-bold text-lg mb-4">System Settings</h3>
                <div class="space-y-4">
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase">School Logo</label>
                        <input type="file" onchange="App.Logic.Data.uploadLogo(this)" class="w-full text-sm">
                    </div>
                    <hr>
                    <button onclick="App.Logic.Data.exportBackup()" class="w-full py-2 border border-blue-200 text-blue-700 rounded hover:bg-blue-50 text-sm font-bold flex items-center justify-center gap-2"><i data-lucide="download" class="w-4 h-4"></i> Backup Data</button>
                    <button onclick="document.getElementById('restore-input').click()" class="w-full py-2 border border-gray-200 text-gray-700 rounded hover:bg-gray-50 text-sm font-bold flex items-center justify-center gap-2"><i data-lucide="upload" class="w-4 h-4"></i> Restore Data</button>
                    <input type="file" id="restore-input" class="hidden" onchange="App.Logic.Data.importBackup(this)">
                </div>
                <button onclick="App.UI.Modals.close('settings')" class="mt-6 w-full py-2 bg-gray-100 text-gray-600 rounded">Close</button>
            </div>
        </div>

    </div>
<script>
    // --- 0. ROBUST INITIALIZATION ---
    let firestore = null;
    let isOffline = false;

    try {
        const firebaseConfig = {
            apiKey: "AIzaSyBHhZ_MIofETSRT37nVBSNDAwOexrdDuwA",
            authDomain: "neerada-payroll.firebaseapp.com",
            projectId: "neerada-payroll",
            storageBucket: "neerada-payroll.firebasestorage.app",
            messagingSenderId: "974433788853",
            appId: "1:974433788853:web:be6eadac8ec50e3808affc"
        };

        // Attempt to load Firebase
        if (typeof firebase !== 'undefined') {
            firebase.initializeApp(firebaseConfig);
            firestore = firebase.firestore();
            console.log("Firebase Connected");
            
            // Try to enable offline persistence (silently fail if not supported)
            firestore.enablePersistence().catch(err => console.log("Persistence warning:", err.code));
        } else {
            throw new Error("Firebase SDK not loaded. Check Internet connection.");
        }
    } catch (e) {
        console.error("System Launch Error:", e);
        isOffline = true;
        alert("Warning: Could not connect to the Cloud Database.\n\nReason: " + e.message + "\n\nPlease check your internet connection and refresh.");
    }

    // --- 1. MAIN APPLICATION ---
    const App = {
        State: {
            employees: [],
            history: [],
            configs: {},
            editor: { id: null, month: '', year: 2026 },
            constants: {
                COLL_EMP: 'employees',
                COLL_HIST: 'history_logs',
                COLL_CFG: 'department_configs',
                MONTHS: ["January","February","March","April","May","June","July","August","September","October","November","December"]
            }
        },

        DB: {
            async getAll(collectionName) {
                if(isOffline || !firestore) return [];
                try {
                    const snapshot = await firestore.collection(collectionName).get();
                    return snapshot.docs.map(doc => doc.data());
                } catch (error) {
                    console.error("DB Error:", error);
                    return [];
                }
            },
            async save(collectionName, data, idField = 'id') {
                if(isOffline || !firestore) { alert("Cannot save: You are offline."); return; }
                try {
                    const docId = data[idField];
                    await firestore.collection(collectionName).doc(docId).set(data);
                    console.log(`Saved: ${docId}`);
                } catch (error) {
                    alert("Save failed: " + error.message);
                }
            },
            async clearCollection(collectionName) {
                if(isOffline || !firestore) return;
                const snapshot = await firestore.collection(collectionName).get();
                const batch = firestore.batch();
                snapshot.docs.forEach((doc) => batch.delete(doc.ref));
                await batch.commit();
            }
        },

        Logic: {
            Config: {
                initDefaults: async () => {
                    if(isOffline) return;
                    const existing = await App.DB.getAll(App.State.constants.COLL_CFG);
                    if (existing.length > 0) return;

                    const LAO_STRUCT = ['Research/Dev', 'Media/Activities', 'Behavior (Basic)', 'Class Resp', 'Policy', 'Basic Salary', 'Certificate', 'Homeroom', 'Behavior (Start)', 'Start Pay', 'Accumulated', 'Increase 25-26'];
                    const DEDUCTIONS = ['Tax 5%', 'Social Security 5.5%', 'Late', 'Others'];
                    const depts = ['Kindergarten', 'Primary', 'Secondary', 'English', 'General Services', 'Accounts'];
                    
                    for(const d of depts) {
                        let earnings = [...LAO_STRUCT];
                        if(d === 'English') earnings = []; 
                        if(d === 'General Services') earnings = ['Salary (LAK)', 'Allowance', 'OT'];
                        const cfg = { name: d, earnings, deductions: [...DEDUCTIONS] };
                        await App.DB.save(App.State.constants.COLL_CFG, cfg, 'name');
                        App.State.configs[d] = cfg;
                    }
                }
            },
            Calculations: {
                run(emp, monthData) {
                    if(!monthData) return { lak: 0, usd: 0 };
                    const d = monthData;
                    if(emp.department === 'English') {
                        const ot = (d.otHours||0) * (d.otRate||0);
                        const grossUSD = (d.basicPay||0) + (d.accumulated||0) + (d.increase||0) + (d.earningsOthersUSD||0) + ot;
                        const dedUSD = (d.profTax||0) + (d.absences||0) + (d.visa||0) + (d.deductionsOthersUSD||0);
                        const netUSD = grossUSD - dedUSD;
                        const convertible = netUSD - (d.cashOut||0);
                        const convertedLAK = convertible * (d.exchangeRate||0);
                        const extraLAK = (d.itLAK||0) + (d.extraWorkOthersLAK||0) + (d.stipendLAK||0);
                        const dedLAK = (d.insuranceLAK||0) + (d.deductionsOthersLAK||0);
                        return { lak: Math.max(0, convertedLAK + extraLAK - dedLAK), usd: d.cashOut||0, grossUSD, netUSD };
                    }
                    let totalEarn = 0; let totalDed = 0;
                    const cfg = App.State.configs[emp.department] || { earnings: [], deductions: [] };
                    if(App.Logic.isLaoAcademic(emp.department)) {
                        const startIndex = cfg.earnings.indexOf('Start Pay');
                        cfg.earnings.forEach((f, i) => { if(i >= startIndex || startIndex === -1) totalEarn += (d[f]||0); });
                    } else {
                        cfg.earnings.forEach(f => totalEarn += (d[f]||0));
                    }
                    totalEarn += (d.overtimeAmount||0);
                    cfg.deductions.forEach(f => totalDed += (d[f]||0));
                    totalDed += (d.loanDeduction||0);
                    return { lak: Math.max(0, totalEarn - totalDed), usd: 0 };
                },
                autoSumLaoFields(data) {
                    const basic = (data['Research/Dev']||0) + (data['Media/Activities']||0) + (data['Behavior (Basic)']||0) + (data['Class Resp']||0) + (data['Policy']||0);
                    data['Basic Salary'] = basic;
                    const start = basic + (data['Certificate']||0) + (data['Homeroom']||0) + (data['Behavior (Start)']||0);
                    data['Start Pay'] = start;
                    return data;
                }
            },
            format: {
                money: (n) => '₭ ' + parseFloat(n||0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}),
                usd: (n) => '$' + parseFloat(n||0).toLocaleString('en-US', {minimumFractionDigits: 2}),
                id: (emp, m, y) => `${(emp.campus||'GS').substring(0,3).toUpperCase()}-${(emp.department||'U').substring(0,1).toUpperCase()}-${emp.name.split(' ')[0].toUpperCase()}-${m.substring(0,3).toUpperCase()}`
            },
            isLaoAcademic: (dept) => !['English', 'General Services', 'Accounts'].includes(dept),
            Data: {
                async saveStaff(e) {
                    e.preventDefault();
                    const fd = new FormData(e.target);
                    const data = Object.fromEntries(fd.entries());
                    const existing = App.State.employees.find(x => x.id === data.id);
                    const emp = { ...existing, ...data, id: data.id || 'EMP_' + Date.now(), lastModified: new Date().toISOString() };
                    await App.DB.save(App.State.constants.COLL_EMP, emp, 'id');
                    await App.Logic.Data.refreshAll();
                    App.UI.renderStaffList();
                    App.UI.Modals.close('staff');
                    App.UI.updateDashboard();
                },
                async refreshAll() {
                    if(isOffline) return;
                    App.State.employees = await App.DB.getAll(App.State.constants.COLL_EMP);
                    App.State.history = await App.DB.getAll(App.State.constants.COLL_HIST);
                    const cfgs = await App.DB.getAll(App.State.constants.COLL_CFG);
                    cfgs.forEach(c => App.State.configs[c.name] = c);
                },
                async triggerImport() {
                    const input = document.createElement('input'); input.type = 'file'; input.accept = '.csv';
                    input.onchange = e => alert("CSV Import logic would go here. (Requires mapping)");
                    input.click();
                },
                copyPrevious() { alert("Feature: Copy previous month data coming soon."); },
                exportBackup() {
                    const exportObj = { employees: App.State.employees, history: App.State.history, configs: App.State.configs, timestamp: Date.now() };
                    const blob = new Blob([JSON.stringify(exportObj)], {type: 'application/json'});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a'); a.href = url; a.download = `Neerada_Backup_${new Date().toISOString().split('T')[0]}.json`;
                    a.click();
                },
                async importBackup(input) {
                    const file = input.files[0]; if(!file) return;
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        const data = JSON.parse(e.target.result);
                        if(confirm(`Restore backup from ${new Date(data.timestamp).toLocaleDateString()}? WARNING: This overwrites Cloud Data.`)) {
                            await App.DB.clearCollection(App.State.constants.COLL_EMP);
                            for(const emp of data.employees) await App.DB.save(App.State.constants.COLL_EMP, emp, 'id');
                            await App.DB.clearCollection(App.State.constants.COLL_CFG);
                            const cfgs = Array.isArray(data.configs) ? data.configs : Object.values(data.configs);
                            for(const c of cfgs) await App.DB.save(App.State.constants.COLL_CFG, c, 'name');
                            location.reload();
                        }
                    };
                    reader.readAsText(file);
                }
            }
        },

        UI: {
            launch() {
                document.getElementById('landing-view').classList.add('hidden');
                document.getElementById('app-view').classList.remove('hidden');
                App.UI.initSelectors();
                App.UI.updateDashboard();
                App.UI.renderStaffList();
            },
            switchTab(tab) {
                document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
                document.getElementById('view-'+tab).classList.remove('hidden');
                document.querySelectorAll('.tab-btn').forEach(el => el.className = "tab-btn px-4 py-1.5 text-sm font-medium rounded-md text-blue-100 hover:bg-blue-700");
                document.querySelector(`button[data-tab="${tab}"]`).className = "tab-btn px-4 py-1.5 text-sm font-medium rounded-md bg-blue-900 text-white shadow-inner";
                if(tab === 'dashboard') App.UI.updateDashboard();
            },
            initSelectors() {
                const y = new Date().getFullYear();
                const m = App.State.constants.MONTHS[new Date().getMonth()];
                document.getElementById('dash-year').innerHTML = [y-1, y, y+1].map(v => `<option value="${v}">${v}</option>`).join('');
                document.getElementById('dash-year').value = y;
                document.getElementById('dash-month').innerHTML = App.State.constants.MONTHS.map(v => `<option value="${v}">${v}</option>`).join('');
                document.getElementById('dash-month').value = m;
                document.getElementById('editor-year').innerHTML = document.getElementById('dash-year').innerHTML;
                document.getElementById('editor-year').value = y;
                document.getElementById('editor-month').innerHTML = document.getElementById('dash-month').innerHTML;
                document.getElementById('editor-month').value = m;
                App.State.editor.month = m; App.State.editor.year = y;
                const depts = Object.keys(App.State.configs);
                document.getElementById('filter-dept').innerHTML = `<option value="All">All Departments</option>` + depts.map(d => `<option value="${d}">${d}</option>`).join('');
                document.getElementById('modal-dept-select').innerHTML = depts.map(d => `<option value="${d}">${d}</option>`).join('');
                document.getElementById('date-display').innerText = new Date().toLocaleDateString();
            },
            updateDashboard() {
                const y = document.getElementById('dash-year').value;
                const m = document.getElementById('dash-month').value;
                const key = `${y}-${m}`;
                let totLAK = 0, totUSD = 0, count = 0;
                App.State.employees.forEach(emp => {
                    if(emp.payrollHistory && emp.payrollHistory[key]) {
                        const res = App.Logic.Calculations.run(emp, emp.payrollHistory[key]);
                        totLAK += res.lak; totUSD += res.usd; count++;
                    }
                });
                document.getElementById('stat-lak').innerText = App.Logic.format.money(totLAK);
                document.getElementById('stat-usd').innerText = App.Logic.format.usd(totUSD);
                document.getElementById('stat-count').innerText = count;
                const hist = App.State.history.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
                document.getElementById('history-log-container').innerHTML = hist.map(h => 
                    `<div class="p-3 border-b flex justify-between items-center text-sm"><div><span class="font-bold text-blue-900">${h.month} ${h.year}</span> <span class="text-xs text-gray-500">(${new Date(h.timestamp).toLocaleDateString()})</span></div><div class="font-mono">${App.Logic.format.money(h.totalLAK)}</div></div>`
                ).join('');
            },
            renderStaffList() {
                const filter = document.getElementById('filter-dept').value;
                let list = App.State.employees;
                if(filter !== 'All') list = list.filter(e => e.department === filter);
                document.getElementById('staff-list').innerHTML = list.map(e => `
                    <div onclick="App.UI.selectEmployee('${e.id}')" class="p-3 bg-white border border-gray-200 rounded-lg cursor-pointer hover:border-blue-400 hover:shadow-sm transition-all ${App.State.editor.id === e.id ? 'border-l-4 border-l-blue-600 ring-1 ring-blue-100' : ''}">
                        <div class="font-bold text-gray-800 text-sm">${e.name}</div>
                        <div class="text-xs text-gray-500 flex justify-between"><span>${e.department}</span><span>${e.position}</span></div>
                    </div>
                `).join('');
            },
            selectEmployee(id) {
                App.State.editor.id = id;
                document.getElementById('empty-state').classList.add('hidden');
                document.getElementById('editor-column').classList.remove('hidden');
                document.getElementById('preview-column').classList.remove('hidden');
                App.UI.renderStaffList();
                App.UI.loadPeriod();
            },
            loadPeriod() {
                if(!App.State.editor.id) return;
                const emp = App.State.employees.find(e => e.id === App.State.editor.id);
                App.State.editor.month = document.getElementById('editor-month').value;
                App.State.editor.year = document.getElementById('editor-year').value;
                const key = `${App.State.editor.year}-${App.State.editor.month}`;
                let data = (emp.payrollHistory && emp.payrollHistory[key]) ? emp.payrollHistory[key] : {};
                App.UI.renderEditor(emp, data);
                App.UI.renderPreview(emp, data);
            },
            renderEditor(emp, data) {
                const container = document.getElementById('editor-inputs');
                let html = '';
                if(emp.department === 'English') {
                    const fields = [{l:'Exchange Rate', k:'exchangeRate'}, {l:'Cash Out ($)', k:'cashOut'}, {l:'Basic Pay ($)', k:'basicPay'}, {l:'Accumulated ($)', k:'accumulated'}, {l:'Increase ($)', k:'increase'}, {l:'OT Hours', k:'otHours'}, {l:'OT Rate', k:'otRate'}, {l:'Prof Tax ($)', k:'profTax'}, {l:'Absences ($)', k:'absences'}, {l:'Visa ($)', k:'visa'}];
                    html = `<div class="grid grid-cols-2 gap-2">` + fields.map(f => `<div><label class="text-[10px] font-bold text-gray-500 uppercase">${f.l}</label><input type="number" oninput="App.UI.handleInput('${f.k}', this.value)" value="${data[f.k]||0}" class="w-full border rounded p-1.5 text-sm"></div>`).join('') + `</div>`;
                } else {
                    const cfg = App.State.configs[emp.department] || {earnings:[], deductions:[]};
                    const isLao = App.Logic.isLaoAcademic(emp.department);
                    html += `<div class="space-y-4"><div class="bg-blue-50 p-3 rounded-lg border border-blue-100"><h4 class="font-bold text-blue-900 text-xs uppercase mb-2">Earnings (LAK)</h4><div class="grid grid-cols-1 gap-2">`;
                    cfg.earnings.forEach(f => {
                        const isAuto = isLao && (f === 'Basic Salary' || f === 'Start Pay');
                        html += `<div><label class="text-[10px] font-bold text-gray-500 truncate block">${f}</label><input type="number" ${isAuto ? 'readonly tabindex="-1"' : ''} oninput="App.UI.handleInput('${f}', this.value)" value="${data[f]||0}" class="w-full border rounded p-1.5 text-sm ${isAuto ? 'bg-gray-100 font-bold text-gray-600' : 'bg-white'}"></div>`;
                    });
                    html += `</div></div><div class="bg-red-50 p-3 rounded-lg border border-red-100"><h4 class="font-bold text-red-900 text-xs uppercase mb-2">Deductions</h4><div class="grid grid-cols-2 gap-2">`;
                    cfg.deductions.forEach(f => { html += `<div><label class="text-[10px] font-bold text-gray-500 truncate block">${f}</label><input type="number" oninput="App.UI.handleInput('${f}', this.value)" value="${data[f]||0}" class="w-full border rounded p-1.5 text-sm text-red-600"></div>`; });
                    html += `</div></div></div>`;
                }
                container.innerHTML = html;
            },
            handleInput(key, val) {
                const emp = App.State.employees.find(e => e.id === App.State.editor.id);
                const k = `${App.State.editor.year}-${App.State.editor.month}`;
                if(!emp.payrollHistory) emp.payrollHistory = {};
                if(!emp.payrollHistory[k]) emp.payrollHistory[k] = {};
                emp.payrollHistory[k][key] = parseFloat(val) || 0;
                if(App.Logic.isLaoAcademic(emp.department)) {
                    emp.payrollHistory[k] = App.Logic.Calculations.autoSumLaoFields(emp.payrollHistory[k]);
                    App.UI.renderEditor(emp, emp.payrollHistory[k]);
                    const input = document.querySelector(`input[oninput*="'${key}'"]`); if(input) input.focus();
                }
                App.UI.renderPreview(emp, emp.payrollHistory[k]);
            },
            renderPreview(emp, data) {
                const res = App.Logic.Calculations.run(emp, data);
                const pid = App.Logic.format.id(emp, App.State.editor.month, App.State.editor.year);
                let detailsHTML = '';
                if(emp.department === 'English') {
                    detailsHTML = `<div class="grid grid-cols-2 gap-4 text-sm border-t pt-4"><div><h4 class="font-bold text-blue-800 mb-2">Earnings ($)</h4><div class="flex justify-between"><span>Basic</span><span>${data.basicPay||0}</span></div><div class="flex justify-between"><span>OT</span><span>${(data.otHours*data.otRate)||0}</span></div><div class="flex justify-between font-bold mt-2"><span>Gross</span><span>${App.Logic.format.usd(res.grossUSD)}</span></div></div><div><h4 class="font-bold text-red-800 mb-2">Deductions</h4><div class="flex justify-between"><span>Tax/Abs/Visa</span><span>${(res.grossUSD - res.netUSD).toFixed(2)}</span></div><div class="flex justify-between"><span>LAK Deductions</span><span>${(data.insuranceLAK||0)}</span></div></div></div><div class="mt-4 bg-gray-100 p-2 rounded text-center"><div class="text-xs text-gray-500">Exchange Rate: ${data.exchangeRate||0}</div><div class="font-bold text-xl text-blue-900">PAY: ${App.Logic.format.money(res.lak)}</div><div class="text-sm text-green-700">Cash Out: ${App.Logic.format.usd(res.usd)}</div></div>`;
                } else {
                    const cfg = App.State.configs[emp.department];
                    detailsHTML = `<div class="space-y-2 mt-4 text-sm">`;
                    cfg.earnings.forEach(f => { if(data[f] > 0) detailsHTML += `<div class="flex justify-between border-b border-gray-100"><span>${f}</span><span class="font-mono">${App.Logic.format.money(data[f])}</span></div>`; });
                    detailsHTML += `</div><div class="mt-6 p-4 bg-blue-900 text-white rounded-lg flex justify-between items-center shadow-lg"><span class="font-bold">NET PAY</span><span class="font-mono text-2xl font-bold">${App.Logic.format.money(res.lak)}</span></div>`;
                }
                document.getElementById('preview-pane').innerHTML = `<div class="text-center border-b pb-4 mb-4"><h2 class="font-hero text-2xl font-bold text-blue-900">Neerada School</h2><p class="text-xs text-gray-500">PAYSLIP: ${App.State.editor.month} ${App.State.editor.year}</p></div><div class="flex justify-between text-xs text-gray-600 mb-4"><div><p><span class="font-bold">Name:</span> ${emp.name}</p><p><span class="font-bold">Position:</span> ${emp.position}</p></div><div class="text-right"><p><span class="font-bold">ID:</span> ${pid}</p><p><span class="font-bold">Dept:</span> ${emp.department}</p></div></div>${detailsHTML}`;
            },
            async saveCurrent() {
                const emp = App.State.employees.find(e => e.id === App.State.editor.id);
                await App.DB.save(App.State.constants.COLL_EMP, emp, 'id');
                alert("Saved to Cloud!");
                App.UI.updateDashboard();
            },
            resetCurrent() {
                if(!confirm("Clear data for this month?")) return;
                const emp = App.State.employees.find(e => e.id === App.State.editor.id);
                const k = `${App.State.editor.year}-${App.State.editor.month}`;
                emp.payrollHistory[k] = {};
                App.UI.selectEmployee(emp.id);
            },
            Modals: {
                open(id) { document.getElementById('modal-'+id).classList.remove('hidden'); document.getElementById('modal-'+id).classList.add('flex'); },
                close(id) { document.getElementById('modal-'+id).classList.add('hidden'); document.getElementById('modal-'+id).classList.remove('flex'); }
            }
        },

        init: async () => {
            // EXPOSE APP IMMEDIATELY
            window.App = App;
            
            // Try to load data in background
            if(!isOffline) {
                try {
                    await App.Logic.Data.refreshAll();
                    if(Object.keys(App.State.configs).length === 0) {
                        await App.Logic.Config.initDefaults();
                        await App.Logic.Data.refreshAll();
                    }
                } catch(e) {
                    console.log("Background load failed:", e);
                }
            }

            if(document.body.classList.contains('view-app')) {
                App.UI.launch();
            }
        }
    };

    // Boot Immediately
    window.addEventListener('DOMContentLoaded', App.init);
</script>
</body>
</html>
